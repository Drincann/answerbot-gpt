// \?session_token\=bb5e42572a0af90e71cc91bfe3c7adbe\&desktop\=true\&page_number\=2\&limit\=6\&action\=down\&after_id\=5\&ad_interval\=-10 cookie:'_zap=ac0628b0-1b3f-4451-88ce-f066b19b626c; _xsrf=a192b3f6-3d4e-41cd-9293-c89befe1952e; Hm_lvt_98beee57fd2ef70ccdd5ca52b9740c49=1670575677; SESSIONID=rQKEr7BftBmXlFVboBY3MwdjSl0QQpPGd7ykJh446Ua; d_c0=AdDX5COY_RWPTmMlqwEK_PyKCZP7ejZ1tvc=|1670575678; JOID=WloTAkK_rqSCdrAZNbaF8u9cIe8ux_vozwWNX1TK5s3dEvdFU45bOeh9vho68krysOMiVCZpwX6a-EUF4Uw7-Qw=; osd=W1kRAU6-raaBerEaN7WJ8-xeIuMvxPnrwwSOXVfG587fEftEUIxYNel-vBk280nws-8jVyRqzX-Z-kYJ4E85-gA=; captcha_session_v2=2|1:0|10:1670575680|18:captcha_session_v2|88:NUlXMjVCRm1FSlcvYXFocXVmNExCOXB6NXNuWDRueHZ4QU9BcTN5Rmdnak9TbFZaVHJiN3VNNmhNRlpjOUNSRQ==|45a4afbdf05785d11956fca732e72fb4bff247fdf0241199cd1204a3b866e055; __snaker__id=AxMyk1LaRpGsVU8N; gdxidpyhxdE=SH9XLTB%5CdwU5tpvfCr76O%2FzQiVzHlwHZq%2BEOLLEj1UgjUVhBqvi8xzL4P%2BEO2gH7Z2Y0n3VTmf5iNX0DOQftg6J%2BIa6pIDVSC3Hakz%5C6SAdOR1IPkKgygbChP6ymItW%2Bs%2BPx8UIP0twdXcRdKhIPB2uN0ubrZsfR56U%2B%2BH5e259wW%2FLZ%3A1670576581671; YD00517437729195%3AWM_NI=3OpaWZRYyE1NH2Q56lu%2BUfpFZAIFN%2F1AR0YIY72A13DHB22JWV4%2BOr2Isc8FYF3ucsKQWgSP%2F0DmtMoALMKNnZ7oEtYqUELkodl7vEPwDzfjf0jkoNQE%2FUHEk46GScRkUE8%3D; YD00517437729195%3AWM_NIKE=9ca17ae2e6ffcda170e2e6eeaedc418c89ffd2f97d83968fa6d55a838e8e87d45290adc0b6f66fed97a9a5eb2af0fea7c3b92af191c082d6529287b7a6b4468cee9fd6b568b7f59b87f34e9a9f87a7cd25f39f9ed1dc439be9fea2b43988988ed3b142958afcccce7af297bd84bb4e9b9afd96e279898f9988d25cedf08c8ef747ad9f84aeca46ae86f990c8809baf9ba6cf61adbca4d8f54f94a98c9be562a6f0a68cee46939be1b6cb4fa9ecfaa8d26992b59ba6bb37e2a3; YD00517437729195%3AWM_TID=gLivUHccA9JARFFBUFLFJf59Exf%2BN0H1; captcha_ticket_v2=2|1:0|10:1670575720|17:captcha_ticket_v2|704:eyJ2YWxpZGF0ZSI6IkNOMzFfRy43Q0dyU2UtcW5EQWpnMEFvaTc2OTg0RTBsWHlQOG5iYkpWUWswT1RuTDQtVHRRQU1OSGo4b3l6dE9FVklVRGVDbThiZ3RwbjlBX1FwbjF0SG9razJKSi5IWXFEczRWQWV2cjhISHg4TjFpd2JPVEpCbGRFcUdUWGcxQmJ0alhPMXQxRUNEX0QyT3V2QlRlSk92bzFkZEphc1IwLjd4Uk8yQ3BZcUdjYWFlQWNhaFhBQUZSRlFNWmtYTWZZVENDYTdnMjRkZGoxa2d4Z1I3Nk9aUVl2TUdQRHNnbWF5d09oYy1HcVVLR0ZGRlFrcnBxVEJUbnJKbklUaF9ndmZ6dU1Nb1kyNkZ0bzVheXp1Z01wQllvZnlsU21WTElsZUZsTGlmMTdHb3ZsNU5DODZUODJQWHIxOXRFblk0SVdibS15RHFXanhRMTdWYTRCX2pZdGhDMGc4WXNWZC01NmhsS2lMZU80bHB2RjVyNG1kbFY5S0dGQVdwZUVWQlFUckFvOERvWWI2Qy5kQUo5Wl92Tnh2cS0xT1R1ejFmVU5QY3hISmVXZXVsSXM5bjR4dVdwNHVBZnhWZEprXzJyak5rbUthYy1UdHVsd25DcWhPUFpHNW9ySUZxRVc3T1FXZVBfMTlVX0c1aTJhTXo5RmdGX0s0QVJtUFdoa0VaMyJ9|c708e4788e9f3abc098aaf462933c0ea89c301be399ea7a87794e9bab490f4a2; z_c0=2|1:0|10:1670575741|4:z_c0|92:Mi4xSUU5MEFBQUFBQUFCME5ma0k1ajlGU1lBQUFCZ0FsVk5mVVNBWkFBak9tUmExS0ZGTGFhcVdUMkRyY2xMSlZGYmNn|029ca7c2f2ca2da298b4845dff22c2c41ff98741d0888867247338f635384703; q_c1=032de191be744a71a12c9736b4b029a7|1670575741000|1670575741000; Hm_lpvt_98beee57fd2ef70ccdd5ca52b9740c49=1670575852; tst=r; KLBRSID=dc02df4a8178e8c4dfd0a3c8cbd8c726|1670575860|1670575676'

import axios from "axios";
import config from "../config.js";
import { GetMemberAnswersParams, GetMemberAnswersResponse } from "./getMemberAnswers.js";
import { GetQuestionParams, GetQuestionResponse } from "./getQuestion.js";
import { pick } from "./helper/pick.js";
import { PostAnswerParams, PostAnswerResponse } from "./postAnswer.js";
import { RecommandListParams, RecommandListResponse } from './recommandList.js'

// init axios
axios.interceptors.request.use((reqConfig) => {
  // console.log('Request:', reqConfig)
  // @ts-ignore
  if (!reqConfig.url?.includes('https://www.zhihu.com/api/v4/members/')) reqConfig.headers['cookie'] = config.cookie
  // @ts-ignore
  reqConfig.headers["Accept-Encoding"] = "gzip,deflate,compress"
  return reqConfig
});

export interface API {
  'recommandList': {
    params: RecommandListParams;
    response: RecommandListResponse;
  };
  'postAnswer': {
    params: PostAnswerParams;
    response: PostAnswerResponse;
  },
  'getQuestion': {
    params: GetQuestionParams;
    response: GetQuestionResponse;
  },
  'getMemberAnswers': {
    params: GetMemberAnswersParams;
    response: GetMemberAnswersResponse;
  }

}

export const interfacesConfig: {
  [APIName in keyof API]: {
    url: (options: any) => string;
    data: (options: API[APIName]['params']) => any;
    method: string;
    headers?: any;
  }
} = {
  'recommandList': {
    url: (_) => 'https://www.zhihu.com/api/v3/feed/topstory/recommend',
    method: 'get',
    data: data => data,
  },
  'postAnswer': {
    url: ({ questionId }: { questionId: string }) => `https://www.zhihu.com/api/v4/questions/${questionId}/answers`,
    method: 'post',
    data: ({ text }) => ({
      content: text.split('\n').map(v => `<p>${v}</p>`).join(''),
      reshipment_settings: 'allowed',
      comment_permission: 'all',
      reward_setting: { can_reward: false }
    }),
  },
  'getQuestion': {
    url: ({ questionId }: { questionId: string }) => `https://www.zhihu.com/question/${questionId}`,
    method: 'get',
    data: (_) => undefined,
  },
  'getMemberAnswers': {
    url: ({ memberName }: { memberName: string }) => `https://www.zhihu.com/api/v4/members/${memberName}/answers%5C?include=data[*].question.is_following`,
    method: 'get',
    data: (data) => ({
      offset: 0, limit: 20, ...pick(data, ['offset', 'limit', 'sort_by']),
    }),
    headers: {},
  }
}

export const call = async <APIName extends keyof API>(api: APIName, data: API[APIName]['params']) => {
  return axios.request<API[APIName]['response']>({
    ...interfacesConfig[api],
    url: interfacesConfig[api].url(data),
    data: interfacesConfig[api].method === 'post' ? interfacesConfig[api].data(data) : undefined,
    params: interfacesConfig[api].method === 'get' ? interfacesConfig[api].data(data) : undefined,
  });
};